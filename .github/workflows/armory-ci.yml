name: Armory CI

on:
  push:
  pull_request:

jobs:
  docs-validate:
    name: docs-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate README selector hub and companion parity
        run: python3 scripts/ci/validate_readmes.py

  catalog-validate:
    name: catalog-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate catalog schema and paths
        run: python3 scripts/validate_shop_catalog.py

      - name: Build manifest from catalog
        run: python3 scripts/build_armory_manifest.py

      - name: Check manifest determinism
        run: python3 scripts/ci/check_manifest_determinism.py

  secret-hygiene:
    name: secret-hygiene
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run secret hygiene scanner
        run: python3 scripts/ci/secret_hygiene.py

      - name: Ensure remote URL has no embedded credentials
        shell: pwsh
        run: pwsh -NoProfile -File scripts/ci/check_remote_url.ps1

  seven-shadow-trust-guard:
    name: seven-shadow-trust-guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate trust store placeholders in bundle mode
        run: python3 scripts/ci/validate_trust_store.py

  powershell-smoke:
    name: powershell-smoke
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run help smoke checks
        shell: pwsh
        run: pwsh -NoProfile -File scripts/ci/help-smoke.ps1

      - name: Run mode contract smoke checks
        shell: pwsh
        run: pwsh -NoProfile -File scripts/ci/mode-contract-smoke.ps1

  fixture-tests:
    name: fixture-tests
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure 7-Zip is available
        shell: pwsh
        run: |
          $candidatePaths = @(
            'C:\Program Files\7-Zip\7z.exe',
            'C:\Program Files (x86)\7-Zip\7z.exe'
          )
          $sevenZipPath = $candidatePaths | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $sevenZipPath) {
            choco install 7zip -y --no-progress
            $sevenZipPath = $candidatePaths | Where-Object { Test-Path $_ } | Select-Object -First 1
          }

          if (-not $sevenZipPath) {
            throw '7-Zip install failed or executable path not found.'
          }

          "SEVEN_ZIP_PATH=$sevenZipPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run fixture tests
        shell: pwsh
        run: pwsh -NoProfile -File scripts/ci/run-fixture-tests.ps1 -SevenZipPath "$env:SEVEN_ZIP_PATH"

      - name: Run chronicle fixture tests
        shell: pwsh
        run: pwsh -NoProfile -File scripts/ci/run-chronicle-tests.ps1

  release-validate:
    name: release-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate changelog and release baseline
        run: python3 scripts/release/validate_release.py --mode ci
